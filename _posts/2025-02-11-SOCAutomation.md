---
title: SOC Automation Project
date: 2025-02-11 12:18:00 -0600
categories: [Cybersecurity, Blue Teaming]
tags: [vm, cloud, windows, ubuntu, siem, soar, automation]     # TAG names should always be lowercase
description: This project goes over the process of setting up a SOC environment utilizing a SIEM, SOAR, and Case Manager. We will automate the workflow of sending alerts to an agent in our effort to simulate a SOC environment,
---

<h2>Environments and Technologies Used</h2>

- VMWare Workstation Pro
- Digital Ocean Cloud Services
- Wazuh (SIEM)
- Shuffle (SOAR)
- TheHive (Case Management)

<h2>Operating Systems Used </h2>

- Windows 10 Pro
- Ubuntu Server 24.04 (x2)

<h2>Objective</h2>

Our goal is to setup a security operations center environment. Due to the heavy system requirements required to run both the SIEM and SOAR tools, we will utilize cloud services through Digital Ocean.

<h2>Walkthrough</h2>

<h3>1. Setting Up Windows 10 Client</h3>

This Windows client will be used by agents for logging in to the Wazuh dashboard. To save on cloud costs, I will be using VMWare Workstation Pro for running a Windows 10 Pro virtual machine. We will need the Windows 10 `.iso` file, which can be downloaded through the [Windows Media Creation Tool](https://www.microsoft.com/en-us/software-download/windows10). After running the media creation tool, select

<img src="/assets/img/soclab/WindowsCreateMedia.png" alt="image" width="70%" height="70%" />

We will be running a 64-bit version of Windows 10.

<img src="/assets/img/soclab/WindowsVersion.png" alt="image" width="70%" height="70%" />

We want create an `.iso` file which we will use when creating our virtual machine.

<img src="/assets/img/soclab/WindowsCreateISO.png" alt="image" width="70%" height="70%" />

Note that this creation process may take a while. Once finished, head over to VMWare Workstation Pro and select `File -> New Virtual Machine`.

<img src="/assets/img/soclab/VMWareCreateVM.png" alt="image" width="70%" height="70%" />

Select typical install. We will not be needing any advanced options for this simple Windows 10 client machine.

<img src="/assets/img/soclab/VMWareTypicalConfig.png" alt="image" width="50%" height="50%" />

Select the `Windows.iso` file we created from the installation media.

<img src="/assets/img/soclab/VMWareSelectISO.png" alt="image" width="50%" height="50%" />

Proceed through the wizard until you reach the hardware settings. For our purposes, 2 CPU cores and 2 GB of memory (2048 MB) will be sufficient.

<img src="/assets/img/soclab/VMWareHardwareSettings.png" alt="image" width="70%" height="70%" />

From here, we can launch the virtual machine and proceed through the Windows installation steps. This part is straightforward for the most part. There are three things you should follow:

- When asked for a Windows product key, select **I don't have a product key**
- When asked which operating system you would like to install, select **Windows 10 Pro**
- When prompted for the installation method, select **Custom: Install Windows only advanced**

<h3>2. Installing Sysmon on our Windows Client</h3>

For our SOC environment, we will utilize **Sysmon**, a Windows service that monitors system logs. Sysmon can detect things like file system changes, process creation, and network connections, among other things. Now that Windows is installed, we can start installing Sysmon. For this part, we will need two things:

- [Sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon) zip file from Microsoft
- [sysmonconfig.xml](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon) from GitHub

Extract the zip file to the same directory as `sysmonconfig.xml` and open the directory in PowerShell as administrator.

<img src="/assets/img/soclab/PowershellSysmonDirectory.png" alt="image" />

Now, to install Sysmon with the configuration file, run `.\Sysmon64.exe -i .\sysmonconfig.xml` In PowerShell.

<img src="/assets/img/soclab/PowershellSysmonInstall.png" alt="image" />

Once the installation is complete, we can confirm the Sysmon is installed by navigating to **Services**.

<img src="/assets/img/soclab/Sysmon64Service.png" alt="image" />

Now, since Sysmon is a system monitoring service, it can create logs in Windows Event Viewer. To view these logs, open Event Viewer and navigate to `Applications and Service Logs -> Microsoft -> Windows -> Sysmon`.

<img src="/assets/img/soclab/EventViewerSysmon.png" alt="image" />

This path contains `Operational.evtx`, which is a proprietary Microsoft Windows XML Event Log file. Opening this will show us all system logs/telemetry generated by Sysmon.

<img src="/assets/img/soclab/EventViewerSysmonLogs.png" alt="image" />

<h3>3. Firewall Configuration</h3>

We need to configure Firewall rules for our virtual machines. Since I am using Digital Ocean, I will set up a cloud-based firewall. The firewall will have the following rules:

- Allow all inbound TCP traffic coming from the Windows 10 Client
- Allow all inbound UDP traffic coming from the Windows 10 Client
- Allow all outbound traffic (TCP/UDP/ICMP)

In Digital Ocean, this is what the firewall configuration looks like:

<img src="/assets/img/soclab/DigitalOceanFirewall.png" alt="image" />

We will later apply this firewall to our virtual machines.


<h3>4. Wazuh Installation</h3>

For this step, we will be leveraging Digital Ocean to create virtual machine in the cloud. Digital Ocean refers to virtual machines as droplets. We will create a droplet for Wazuh and configure it as follows:

- Pick the closest region for the lowest latency

- We will select Ubuntu 24.04 (LTS) x64 as the OS

  <img src="/assets/img/soclab/WazuhDropletOS.png" alt="image" />

- We will select the highest available option for CPU and RAM. Wazuh performs best with 8 GB of RAM

  <img src="/assets/img/soclab/WazuhDropletSize.png" alt="image" />

- For convenience, we will authenticate with a password instead of an SSH key.

  <img src="/assets/img/soclab/WazuhDropletPassword.png" alt="image" />

Once the droplet has been created, we can add it to the firewall we created in step 3. Here is what that looks like.

<img src="/assets/img/soclab/WazuhDropletAddedToFirewall.png" alt="image" />

Now, we can SSH from our Windows client into our Wazuh VM via SSH. We can grab the IP of the Wazuh droplet and connect to it as root. Note that by default, the drop only has the root user. From our Windows client, we can execute the command

`ssh root@138.197.172.37`

where `138.197.172.37` is the public IP of the Wazuh droplet. After successfully authenticating with the root password, we can start installing Wazuh. We will be doing the quickstart installation as given in the official [Wazuh documentation](https://documentation.wazuh.com/current/quickstart.html). In the Windows client's SSH session, paste the following command and execute it.

```bash
apt update ; apt upgrade -y ; curl -sO https://packages.wazuh.com/4.10/wazuh-install.sh && sudo bash ./wazuh-install.sh -a
```

The curl command above will install the Wazuh Indexer, Wazuh Server, and Wazuh Dashboard all in one go. **When the installation is finished, keep note of the username and password. This will be used to sign in to Wazuh through the dashboard.** We can access the Wazuh dashboard by accessing the Wazuh server through https. Since the Wazuh droplet has a public IP address of `138.197.172.37`, we can access Wazuh through the Windows client by visiting `https://138.197.172.37` in a browser.

<img src="/assets/img/soclab/WazuhDashboardLogin.png" alt="image" />

If the login process is successful, you will be presented with the dashboard page.

<img src="/assets/img/soclab/WazuhMainPage.png" alt="image" />

<h3>5. TheHive Installation+Configuration</h3>

For our SOC environment, TheHive will primarily be used as a case management tool. We will create a droplet for TheHive. We will use the same OS (Ubuntu 24.04 LTS x64), same hardware specs (2 CPUs and 8 GB RAM), and a password for access the server. Once the droplet is created, we can quickly add it to our firewall.

<img src="/assets/img/soclab/TheHiveAddedToFirewall.png" alt="image" />

With the droplet now created and added to the firewall, we can SSH from our Windows client into this droplet. After successfully connecting to the droplet, we can upgrade the packages.

```bash
apt update ; apt upgrade -y
```

we can begin installing TheHive along with its dependencies. TheHive will require CassandraDB for its database and ElasticSearch for searching. We can follow the official installation steps in the documentation to get TheHive up and running. The following will be installed in order:

- Java
- Cassandra DB
- ElasticSearch
- TheHive

This installation process is quite lengthy, so be sure to follow the installation steps at [https://docs.strangebee.com/thehive/installation/step-by-step-installation-guide/](https://docs.strangebee.com/thehive/installation/step-by-step-installation-guide/). For configuring each of these services, use the following.

Cassandra config (`/etc/cassandra/cassandra.yaml`):

- `cluster_name: <ANY NAME>`
- `listen_address: <PUBLIC IP OF THEHIVE DROPLET>`
- `rpc_address: <PUBLIC IP OF THEHIVE DROPLET>`
- `seeds: "<PUBLIC IP OF THEHIVE DROPLET>:7000"`

ElasticSearch config (`/etc/elasticsearch/elasticsearch.yml`):

- `cluster.name: <NAME OF CASSANDRA CLUSTER>`
- `node.name: node-1`
- `path.data: /var/lib/elasticsearch`
- `path.logs: /var/log/elasticsearch`
- `network.host: <PUBLIC IP OF THEHIVE DROPLET>`
- `http.port: 9200`
- `cluster.initial_master_nodes: ["node-1"]`

ElasticSearch JVM Settings (`/etc/elasticsearch/jvm.options.d/jvm.options`):

```
-Dlog4j2.formatMsgNoLookups=true
-Xms2g
-Xmx2g
```

Local Filestorage:

- Create directory with `mkdir -p /opt/thp/thehive/files`
- Create user named `thehive` with `adduser thehive`
- Change access permissions of our new directory with `chown -R thehive:thehive /opt/thp`

TheHive config (`/etc/thehive/application.conf`):

- `hostname = ["143.198.32.186"]`
- `cluster-name = <NAME OF CASSANDRA CLUSTER>`
- `application.baseUrl = "http://<PUBLIC IP OF THEHIVE DROPLET>:9000"`
- Uncomment final two lines to enable `Cortex` and `MISP` modules for data enrichment.

Once all these services are installed, configured, and running, we can access TheHive through our web browser by visiting `<PUBLIC IP OF THE HIVE DROPLET>:9000`. The default credentials are `admin@thehive.local/secret`. If successful, we will be greeted with the following page.

<img src="/assets/img/soclab/TheHiveHomepage.png" alt="image" />

<h3>6. Wazuh Configuration</h3>

We now head back to the Wazuh SSH session. Recall when we called `curl` to retrieve the Wazuh installation script, we also retrieved a `.tar` archive. We can extract all the files from this archive with

`tar xvf wazuh-install-files.tar`

This will extract the files to a directory of the same name.

<img src="/assets/img/soclab/WazuhTarExtract.png" alt="image" />

Keep note of the API user credentials for later as we will use this later on. Heading back to the Wazuh dashboard, we can deploy a new agent.

<img src="/assets/img/soclab/WazuhDashboardDeployAgent.png" alt="image" />

Our Wazuh agent is on our Windows client. The server address is the public IP of our Wazuh droplet. Choose any name for the agent.

<img src="/assets/img/soclab/WazuhAgentDetails.png" alt="image" />

From these settings, Wazuh will generate us a Powershell command which we can copy and execute to deploy our new agent. Run PowerShell with administrator rights and paste the given command. In my case, the command is

`Invoke-WebRequest -Uri https://packages.wazuh.com/4.x/windows/wazuh-agent-4.10.1-1.msi -OutFile $env:tmp\wazuh-agent; msiexec.exe /i $env:tmp\wazuh-agent /q WAZUH_MANAGER='138.197.172.37' WAZUH_AGENT_NAME='Smith'`

Finally, start the Wazuh service with `NET START WazuhSvc`. Confirm that the Wazuh service is running in Windows Services.

<img src="/assets/img/soclab/WazuhServiceRunning.png" alt="image" />

The Wazuh dashboard should now show one active agent.

<img src="/assets/img/soclab/WazuhActiveAgent.png" alt="image" />

Indeed, we can see that this is the agent we just created.

<img src="/assets/img/soclab/WazuhAgentSmithActive.png" alt="image" />

<h3>7. Generating Telemetry for Wazuh</h3>

Now that all the services are installed and configured, we can start fine tuning our Wazuh SIEM to detect malicious traffic. We will be utilizing the open source credential sniffer `Mimikatz` to generate telemetry. When we generated the agent, Wazuh created the directory `C:\Program Files (x86)\ossec-agent`. The file we are interested in is `ossec.conf`, so open it in notepad with administrator rights. We want to ingest Wazuh with Sysmon logs, so change the lines under the `<!-- Log analysis -->` section to

```conf
<!-- Log analysis -->
  <localfile>
    <location>Microsoft-Windows-Sysmon/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <localfile>
    <location>active-response\active-responses.log</location>
    <log_format>syslog</log_format>
  </localfile>
```

This ensures that Wazuh only picks up Sysmon logs. To apply these changes, restart the Wazuh service. Then head over to the discover page of Wazuh, select `wazuh-alerts` as the index pattern and search for `sysmon`.

<img src="/assets/img/soclab/WazuhSysmonSearch.png" alt="image" />

Before we can install Mimikatz, we need to add exclude it so Windows Defender doesn't block the file. Under `Virus and Threat Protection Settings`, click on `Add or remove exclusions` to add the **Downloads** folder as an exclusion as this is where Mimikatz will be downloaded.

<img src="/assets/img/soclab/DownloadsFolderExclusion.png" alt="image" />

Now we can download `mimikatz_trunk.zip` from [https://github.com/gentilkiwi/mimikatz/releases](https://github.com/gentilkiwi/mimikatz/releases) and extract the zip. To ensure that Wazuh picks up Mimikatz telemetry, we need to tune Wazuh alerts. We can do this by logging in to our Wazuh droplet via SSH and navigating to `/var/ossec/etc/ossec.conf` to make the following changes:

- `<logall>yes</logall>`
- `<logall_json>yes</logall_json>`

Restart the `wazuh-manager` service to apply these changes. Next, we make the following changes to `/etc/filebeat/filebeat.yaml`:

```yaml
filebeat.modules:
   ...
    archives:
      enabled: true
```
Restart the `filebeat` service to apply these changes. Now, head back to Wazuh and navigate to `Dashboard Management -> Index Patterns -> Create Index Patterns`.

<img src="/assets/img/soclab/WazuhIndexPatternName.png" alt="image" />
<img src="/assets/img/soclab/WazuhIndexPatternTimeField.png" alt="image" />

Wazuh is now setup to consolidate all logs, regardless of if the event is triggered by a rule. Open PowerShell as administrator, navigate to `C:\Users\Smith\Downloads\mimikatz_trunk\x64`, and run `.\mimikatz.exe`.

<img src="/assets/img/soclab/PowershellRunMimikatz.png" alt="image" />

Heading back to Wazuh, we can see mimikatz telemetry under our new index pattern.

<img src="/assets/img/soclab/WazuhMimikatzSearch.png" alt="image" />

We now create a rule that specifically catches when Mimikatz is running. On Wazuh, navigate to `Server Management -> Rules -> Custom Rules` and click on the `local_rules.xml` to edit it.

<img src="/assets/img/soclab/WazuhLocalRules.png" alt="image" />

We will add the following rule to detect when Mimikatz is run.

```xml
<rule id="100002" level="15">
  <if_group>sysmon_event1</if_group>
  <field name="win.eventdata.originalFilename" type="pcre2">(?i)mimikatz\.exe</field>
  <description>Mimikatz Usage Detected</description>
  <mitre>
    <id>T1003</id>
  </mitre>
</rule>
```

This rule detects when mimikatz is run even if it is run under a different file name. Note that T1003 is the ID for **credential dumping**. Restart the manager after you save the changes. To test that this rule triggers an alert, let's rename `mimikatz.exe` to `trustme.exe` and run it in PowerShell.

<img src="/assets/img/soclab/PowershellRunRenamedMimikatz.png" alt="image" />

If we head back to Wazuh manager and check the logs, we can see that the rule did indeed trigger an alert.

<img src="/assets/img/soclab/WazuhRuleTriggerMimikatz.png" alt="image" />

<h3>8. Integrating Wazuh into Shuffle</h3>

Shuffle will be used as our SOAR platform for grabbing the alerts generated by Wazuh and sending them to TheHive. Begin by creating an account on [suffler.io](https://shuffler.io) and create a new workflow.

<img src="/assets/img/soclab/ShuffleCreateWorkflow.png" alt="image" />

For our purposes, we will create a workflow with the following settings.

<img src="/assets/img/soclab/ShuffleNewWorkflowInfo.png" alt="image" width="40%" height="40%" />

From the workflow screen, we can begin dragging triggers to configure the workflow we want.

<img src="/assets/img/soclab/ShuffleEmptyWorkflow.png" alt="image" />

We can begin with configuring a webhook. This webhook will allow Shuffle to automate communication with the Wazuh API. Give a name to the webhook and grab the webhook URI.

<img src="/assets/img/soclab/ShuffleCreateWazuhWebhook.png" alt="image" />

In our Wazuh droplet, we need to add this webhook URI to `/var/ossec/etc/ossec.conf` and add the following code after the `global` tag.

```conf
<integration>
  <name>shuffle</name>
  <hook_url>http://<YOUR_SHUFFLE_URL>/api/v1/hooks/<HOOK_ID></hook_url>
  <rule_id>100002</rule_id>
  <alert_format>json</alert_format>
</integration>
```

Replace `http://<YOUR_SHUFFLE_URL>/api/v1/hooks/<HOOK_ID>` with the webhook URI we copied from Shuffle. Note that the `rule_id` here is the same as the one we assigned to Mimikatz in Wazuh. Once these changes have been written to the config, restart the `wazuh-manager` service.

To test that Wazuh has been properly integrated, we can run a test to see if the Mimikatz logs are captured by this simple webhook integration. Click the `Change Me` node and apply the following settings.

<img src="/assets/img/soclab/ShuffleRepeater.png" alt="image" />

Then start the `Wazuh-Alerts` webhook.

<img src="/assets/img/soclab/ShuffleStartWazuhWebhook.png" alt="image" />

In the Windows client, run mimikatz in PowerShell as admininstrator. Note that we renamed the mimikatz executable file `trustme.exe`. After running mimikatz, we should see the log in our Shuffle workflow run history.

<img src="/assets/img/soclab/ShuffleWazuhAlertTest.png" alt="image" />

<h3>9. Integrating VirusTotal into Shuffle</h3>

Now that Shuffle is configured to retrieve any Mimikatz alert from Wazuh, we can parse the alert, grab the hash value associated with the alert, send the hash to VirusTotal, and get back the report on the hash. To do so, we will need an API key from VirusTotal, which requires an account. After signing in to VirusTotal, click on your name at the top right and select `API Key`, and copy the API key.

<img src="/assets/img/soclab/VirusTotalAPIKey.png" alt="image" />

On our Shuffle workflow, modify the `Change Me` node to extract the SHA256 hash using regex, and get the hash report from VirusTotal.

<img src="/assets/img/soclab/ShuffleGetHash.png" alt="image" />

<img src="/assets/img/soclab/ShuffleVirusTotal.png" alt="image" />

Running this workflow gives us the following result from VirusTotal.

<img src="/assets/img/soclab/ShuffleVirusTotalWorkflowRun.png" alt="image" />

Notice that the `malicious` score is the one we would see on VirusTotal for mimikatz.

<img src="/assets/img/soclab/MimikatzVirusTotalScore.png" alt="image" />

<h3>10. Integrating TheHive into Shuffle</h3>

With the VirusTotal hash report, we can now create a case in TheHive. On the Windows client, head to TheHive's dashboard and create a new organization.

<img src="/assets/img/soclab/TheHiveCreateOrganization.png" alt="image" />

Click on the new organization and add two new users to it. The first user will be a normal user and the second user will be a service user.

<img src="/assets/img/soclab/TheHiveNormalUser.png" alt="image" width="45%" />
<img src="/assets/img/soclab/TheHiveSOARUser.png" alt="image" width="45%" />

From here we will do two things:

- Create a password for the normal user
- Create an API key for the service user

Click the little eye icon for each user to accomplish this. Once the API key is generated, save it somewhere, log out of the admin account, and log back into TheHive dashboard with the normal user's credentials.

<img src="/assets/img/soclab/TheHiveLoginNormalUser.png" alt="image" />

Head back to the Shuffle workflow and configure add TheHive app with the following authentication settings:

- apikey: `<API KEY OF YOUR SERVICE USER>`
- url: `http://<PUBLIC IP OF THE HIVE DROPLET>:9000`

For TheHive app's settings, change to the advanced tab and add the following json to the body field. Unfortunately, the use of variables causes issues when trying to send the alert to TheHive, so we can't be as specific in our description and summary. This may have something to do with the Shuffle platform. Also, the **simple** tab fails to parse the fields into proper json, so we must provide the json below in the body field of the **advanced** tab.

```json
{
  "description": "Mimikatz was detected. Possible credential dumping.",
  "externallink": "",
  "flag": false,
  "pap": 2,
  "severity": "2",
  "source": "Wazuh",
  "sourceRef": "Rule 100002",
  "status": "New",
  "summary": "Mimikatz was detected",
  "tags": ["T1003"],
  "title": "Mimikatz Detected",
  "tlp": 2,
  "type": "Internal"
}
```

After applying these settings, add a firewall rule to allow Shuffle to send the alert to TheHive. Note that TheHive service is running on port 9000.

<img src="/assets/img/soclab/ShuffleCustomFirewallRule.png" alt="image" />

Once the firewall rule is added, ensure that there is a direct link from the VirusTotal app to TheHive app, and run the workflow.

<img src="/assets/img/soclab/ShuffleTheHiveLinkedToVirusTotal.png" alt="image" />

If all goes well, we should get an alert automatically created on TheHive dashboard for our normal user.

<img src="/assets/img/soclab/TheHiveAutomatedAlert.png" alt="image" />
